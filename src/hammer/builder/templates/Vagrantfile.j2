# -*- mode: ruby -*-
# vi: set ft=ruby :

# HAMMER Assignment: {{ assignment_id }}
# Generated Vagrantfile - Do not edit manually

Vagrant.configure("2") do |config|
  config.vm.box = "{{ box_name }}"
  config.vm.synced_folder ".", "/vagrant", disabled: true

{% for node in nodes %}
  config.vm.define "{{ node.name }}" do |{{ node.name }}|
{% if domain %}
    {{ node.name }}.vm.hostname = "{{ node.name }}.{{ domain }}"
{% else %}
    {{ node.name }}.vm.hostname = "{{ node.name }}"
{% endif %}
    {{ node.name }}.vm.network "private_network",
      ip: "{{ network.node_ip_map[node.name] }}"
{% if node.forwarded_ports %}
{% for port in node.forwarded_ports %}
    {{ node.name }}.vm.network "forwarded_port",
      guest: {{ port.guest_port }},
      host: {{ port.host_port }},
      protocol: "{{ port.protocol }}"
{% endfor %}
{% endif %}

    {{ node.name }}.vm.provider :libvirt do |libvirt|
      libvirt.default_prefix = "{{ assignment_id }}_"
      libvirt.memory = {{ node.resources.ram_mb }}
      libvirt.cpus = {{ node.resources.cpu }}
    end

    # Configure /etc/hosts for inter-node name resolution
    {{ node.name }}.vm.provision "shell", inline: <<-SHELL
{% for other_node in nodes %}
{% if domain %}
      grep -q {{ (other_node.name ~ "." ~ domain) | shellescape }} /etc/hosts || echo {{ (network.node_ip_map[other_node.name] ~ " " ~ other_node.name ~ " " ~ other_node.name ~ "." ~ domain) | shellescape }} >> /etc/hosts
{% else %}
      grep -q {{ (" " ~ other_node.name ~ "$") | shellescape }} /etc/hosts || echo {{ (network.node_ip_map[other_node.name] ~ " " ~ other_node.name) | shellescape }} >> /etc/hosts
{% endif %}
{% endfor %}
    SHELL
  end

{% endfor %}
end
