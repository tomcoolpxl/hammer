"""HAMMER Generated Test Configuration.

Assignment: {{ assignment_id }}
Phase: {{ phase }}

This file is auto-generated. Do not edit manually.
"""

import pytest
import testinfra


def pytest_configure(config):
    """Register custom markers."""
    config.addinivalue_line("markers", "baseline: tests for baseline phase")
    config.addinivalue_line("markers", "mutation: tests for mutation phase")
    config.addinivalue_line("markers", "idempotence: tests for idempotence phase")
    config.addinivalue_line("markers", "weight(val): weight for scoring")


def pytest_json_runtest_metadata(item):
    """Add weight marker to json report metadata."""
    metadata = {}
    for mark in item.iter_markers(name="weight"):
        if mark.args:
            metadata["weight"] = mark.args[0]
    return metadata


@pytest.fixture(scope="module")
def vagrant_ssh_config(tmp_path_factory):
    """Generate SSH config from Vagrant."""
    import subprocess
    import os

    # Get the student bundle directory (parent of tests/)
    bundle_dir = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))

    result = subprocess.run(
        ["vagrant", "ssh-config"],
        capture_output=True,
        text=True,
        cwd=bundle_dir,
    )

    if result.returncode != 0:
        pytest.skip(f"Could not get vagrant ssh-config: {result.stderr}")

    ssh_config_path = tmp_path_factory.mktemp("ssh") / "config"
    ssh_config_path.write_text(result.stdout)
    return str(ssh_config_path)


{% for node in nodes %}
@pytest.fixture(scope="module")
def host_{{ node.name }}(vagrant_ssh_config):
    """Testinfra host fixture for {{ node.name }}."""
    return testinfra.get_host(
        "paramiko://{{ node.name }}",
        ssh_config=vagrant_ssh_config,
    )


{% endfor %}
# Network information for reachability tests
NETWORK = {
{% for node_name, ip in network.node_ip_map.items() %}
    "{{ node_name }}": "{{ ip }}",
{% endfor %}
}
