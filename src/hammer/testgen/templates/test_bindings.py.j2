"""HAMMER Generated Binding Tests.

Assignment: {{ assignment_id }}
Phase: {{ phase }}

Tests that verify variable bindings are correctly applied.
"""

import pytest


{% for test in tests %}
@pytest.mark.{{ phase }}
@pytest.mark.weight({{ test.weight }})
def test_{{ test.test_name }}(host_{{ test.host }}):
    """{{ test.description }}"""
{% if test.binding_type == "service_listen_port" %}
    # Check that service is listening on expected port
    socket = host_{{ test.host }}.socket("{{ test.protocol | pyescape }}://{{ test.address | pyescape }}:{{ test.expected_value }}")
    assert socket.is_listening, \
        f"Expected {{ test.service | pyescape }} to listen on {{ test.address | pyescape }}:{{ test.expected_value }}"
{% elif test.binding_type == "firewall_port_open" %}
    # Check firewall port is open
    cmd = host_{{ test.host }}.run("sudo firewall-cmd --list-ports --zone={{ test.zone | pyescape }}")
    assert cmd.rc == 0, "Failed to query firewall"
    assert "{{ test.expected_value }}/{{ test.protocol | pyescape }}" in cmd.stdout, \
        f"Expected port {{ test.expected_value }}/{{ test.protocol | pyescape }} to be open in zone {{ test.zone | pyescape }}"
{% elif test.binding_type == "template_contains" or test.binding_type == "file_contains" %}
    # Check file contains expected pattern
    f = host_{{ test.host }}.file("{{ test.path | pyescape }}")
    assert f.exists, f"File {{ test.path | pyescape }} does not exist"
    assert f.contains("{{ test.expected_pattern | pyescape }}"), \
        f"File {{ test.path | pyescape }} does not contain expected pattern"
{% elif test.binding_type == "file_exists" %}
    # Check file exists
    f = host_{{ test.host }}.file("{{ test.path | pyescape }}")
    assert f.exists, f"File {{ test.path | pyescape }} does not exist"
{% elif test.binding_type == "file_mode" %}
    # Check file mode
    f = host_{{ test.host }}.file("{{ test.path | pyescape }}")
    assert f.exists, f"File {{ test.path | pyescape }} does not exist"
    assert f.mode == {{ test.mode }}, \
        f"Expected mode {{ test.mode }}, got {f.mode}"
{% elif test.binding_type == "file_owner" %}
    # Check file ownership
    f = host_{{ test.host }}.file("{{ test.path | pyescape }}")
    assert f.exists, f"File {{ test.path | pyescape }} does not exist"
    assert f.user == "{{ test.owner | pyescape }}", f"Expected owner {{ test.owner | pyescape }}, got {f.user}"
    assert f.group == "{{ test.group | pyescape }}", f"Expected group {{ test.group | pyescape }}, got {f.group}"
{% endif %}


{% endfor %}
