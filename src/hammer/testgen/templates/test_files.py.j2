"""HAMMER Generated File Tests.

Assignment: {{ assignment_id }}
Phase: {{ phase }}

Tests that verify file states.
"""

import pytest


{% for test in tests %}
{% for host in test.hosts %}
{% for item in test.file_items %}
@pytest.mark.{{ phase }}
@pytest.mark.weight({{ test.weight }})
def test_file_{{ item.safe_name }}_on_{{ host }}(host_{{ host }}):
    """Verify file {{ item.path }} on {{ host }}."""
    f = host_{{ host }}.file("{{ item.path | pyescape }}")
{% if item.present %}
    assert f.exists, f"File {{ item.path | pyescape }} should exist on {{ host }}"
{% if item.is_directory %}
    assert f.is_directory, f"{{ item.path | pyescape }} should be a directory on {{ host }}"
{% endif %}
{% if item.mode %}
    assert f.mode == {{ item.mode }}, \
        f"File {{ item.path | pyescape }} should have mode {{ item.mode }}, got {f.mode}"
{% endif %}
{% if item.owner %}
    assert f.user == "{{ item.owner | pyescape }}", \
        f"File {{ item.path | pyescape }} should be owned by {{ item.owner | pyescape }}, got {f.user}"
{% endif %}
{% if item.group %}
    assert f.group == "{{ item.group | pyescape }}", \
        f"File {{ item.path | pyescape }} should have group {{ item.group | pyescape }}, got {f.group}"
{% endif %}
{% if item.content_regex and not item.is_directory %}
    content_pattern = r"{{ item.content_regex | pyescape }}"
    assert f.contains(content_pattern), \
        f"File {{ item.path | pyescape }} should contain pattern matching regex"
{% endif %}
{% else %}
    assert not f.exists, f"File {{ item.path | pyescape }} should not exist on {{ host }}"
{% endif %}


{% endfor %}
{% endfor %}
{% endfor %}
